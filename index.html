<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TIKTOK VIRAL - Shorts Trending</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
  </head>
  <body>
    <header class="header">
      <h1>TIKTOK VIRAL</h1>
      <svg
        class="youtube-icon"
        viewBox="0 0 24 24"
        fill="#FF0000"
        onclick="window.open('https://www.youtube.com/@tiktok-viralgl', '_blank')"
      >
        <path
          d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"
        />
      </svg>
    </header>

    <div id="videoModal" class="modal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">√ó</button>
        <iframe
          id="videoPlayer"
          width="100%"
          height="100%"
          frameborder="0"
          allowfullscreen
        ></iframe>
      </div>
    </div>

    <main class="container">
      <div class="shorts-container">
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="recent">
            R√©cents
          </button>
          <button class="filter-btn" data-filter="popular">Populaires</button>
          <button class="filter-btn" data-filter="trending">Tendances</button>
        </div>
        <div class="shorts-grid" id="shortsGrid"></div>
        <button class="load-more" id="loadMore">Charger plus</button>
      </div>

      <aside class="ad-section">
        <h2 style="margin-bottom: 1rem; font-size: 1.5rem">Trending Now üî•</h2>
        <div class="ad-container">
          <div style="text-align: center">
            <p style="font-size: 1.2rem; margin-bottom: 1rem">
              Espace Publicitaire
            </p>
            <p style="opacity: 0.7">Votre publicit√© ici</p>
          </div>
        </div>
      </aside>
    </main>

    <script>
      const API_KEY = "AIzaSyDtJfHn84GJq5pGXXRuBPDNXxa6_tz5S1M";
      const CHANNEL_ID = "UClLWYh8gDlL8pkclSrE-yAg";
      const CACHE_DURATION = 24 * 60 * 60 * 1000;
      const CACHE_KEY_PREFIX = "tiktok_viral_";
      const MAX_API_CALLS_PER_DAY = 50;
      let nextPageToken = "";
      let currentFilter = "recent";

      // D√©finition des vid√©os par d√©faut
      const DEFAULT_SHORTS = [
        {
          id: { videoId: "UJAH65fxDR0" },
          snippet: {
            title: "üåü Best TikTok",
            publishedAt: new Date().toISOString(),
            thumbnails: {
              high: { url: `https://i.ytimg.com/vi/UJAH65fxDR0/hqdefault.jpg` },
            },
          },
        },
        {
          id: { videoId: "2QB-tQGGXag" },
          snippet: {
            title: "‚ö° Trending TikTok",
            publishedAt: new Date().toISOString(),
            thumbnails: {
              high: { url: `https://i.ytimg.com/vi/2QB-tQGGXag/hqdefault.jpg` },
            },
          },
        },
        {
          id: { videoId: "6ZvlP7b2WbM" },
          snippet: {
            title: "‚ú® TikTok Viral",
            publishedAt: new Date().toISOString(),
            thumbnails: {
              high: { url: `https://i.ytimg.com/vi/6ZvlP7b2WbM/hqdefault.jpg` },
            },
          },
        },
        {
          id: { videoId: "u3KpAL_lrDU" },
          snippet: {
            title: "üî• Top TikTok",
            publishedAt: new Date().toISOString(),
            thumbnails: {
              high: { url: `https://i.ytimg.com/vi/u3KpAL_lrDU/hqdefault.jpg` },
            },
          },
        },
        {
          id: { videoId: "znOLAIG3yoM" },
          snippet: {
            title: "üí´ Best TikTok",
            publishedAt: new Date().toISOString(),
            thumbnails: {
              high: { url: `https://i.ytimg.com/vi/znOLAIG3yoM/hqdefault.jpg` },
            },
          },
        },
      ];

      // Fonctions de gestion du compteur API
      function checkAndResetApiCounter() {
        const today = new Date().toDateString();
        const lastReset = localStorage.getItem("lastApiReset");
        if (lastReset !== today) {
          localStorage.setItem("apiCallsToday", "0");
          localStorage.setItem("lastApiReset", today);
        }
      }

      function incrementApiCounter() {
        const calls = parseInt(localStorage.getItem("apiCallsToday") || "0");
        localStorage.setItem("apiCallsToday", (calls + 1).toString());
        return calls + 1;
      }

      function canMakeApiCall() {
        const calls = parseInt(localStorage.getItem("apiCallsToday") || "0");
        // On v√©rifie si on a assez de quotas pour les 2 appels n√©cessaires
        return calls < MAX_API_CALLS_PER_DAY - 1;
      }

      // Fonctions de gestion du cache
      function getCacheKey(filter, page = "") {
        return `${CACHE_KEY_PREFIX}${filter}_${page}`;
      }

      function saveToCache(key, data) {
        try {
          const cacheData = {
            timestamp: Date.now(),
            data: data,
          };
          localStorage.setItem(key, JSON.stringify(cacheData));
        } catch (error) {
          console.warn("Erreur de cache:", error);
        }
      }

      function getFromCache(key) {
        try {
          const cached = localStorage.getItem(key);
          if (!cached) return null;

          const cacheData = JSON.parse(cached);
          if (Date.now() - cacheData.timestamp > CACHE_DURATION) {
            return null;
          }

          return cacheData.data;
        } catch (error) {
          return null;
        }
      }

      // Gestionnaires d'√©v√©nements
      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentFilter = btn.dataset.filter;
          nextPageToken = "";
          const grid = document.getElementById("shortsGrid");
          grid.innerHTML = "";
          await loadShorts();
        });
      });

      function openModal(videoId) {
        const modal = document.getElementById("videoModal");
        const videoPlayer = document.getElementById("videoPlayer");
        videoPlayer.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        const modal = document.getElementById("videoModal");
        const videoPlayer = document.getElementById("videoPlayer");
        videoPlayer.src = "";
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }

      async function fetchShorts() {
        const cacheKey = getCacheKey(currentFilter, nextPageToken);
        const cachedData = getFromCache(cacheKey);

        if (cachedData) {
          console.log("üì¶ Utilisation du cache");
          return cachedData;
        }

        checkAndResetApiCounter();
        if (!canMakeApiCall()) {
          console.log(
            "üö´ Limite API atteinte, utilisation du contenu hors-ligne"
          );
          return {
            items: DEFAULT_SHORTS,
            nextPageToken: "",
          };
        }

        try {
          const response = await axios.get(
            "https://www.googleapis.com/youtube/v3/search",
            {
              params: {
                key: API_KEY,
                channelId: CHANNEL_ID,
                part: "snippet",
                maxResults: 16,
                type: "video",
                videoDuration: "short",
                pageToken: nextPageToken || "",
                order:
                  currentFilter === "popular"
                    ? "viewCount"
                    : currentFilter === "trending"
                    ? "rating"
                    : "date",
              },
            }
          );

          incrementApiCounter();
          console.log("üîÑ Appel API r√©ussi");

          const videoIds = response.data.items
            .map((item) => item.id.videoId)
            .join(",");

          const statsResponse = await axios.get(
            "https://www.googleapis.com/youtube/v3/videos",
            {
              params: {
                key: API_KEY,
                id: videoIds,
                part: "statistics",
              },
            }
          );

          incrementApiCounter();

          const items = response.data.items.map((item) => {
            const stats =
              statsResponse.data.items.find(
                (statItem) => statItem.id === item.id.videoId
              )?.statistics || null;
            return { ...item, statistics: stats };
          });

          const resultData = {
            items: items,
            nextPageToken: response.data.nextPageToken || "",
          };

          saveToCache(cacheKey, resultData);
          return resultData;
        } catch (error) {
          console.log(
            "‚ùå Erreur API:",
            error.response?.status || error.message
          );
          return {
            items: DEFAULT_SHORTS,
            nextPageToken: "",
          };
        }
      }

      function formatCount(count) {
        if (!count) return "0";
        count = parseInt(count);
        if (count >= 1000000) {
          return (count / 1000000).toFixed(1) + "M";
        }
        if (count >= 1000) {
          return (count / 1000).toFixed(1) + "K";
        }
        return count.toString();
      }

      function createShortCard(short) {
        const views = short.statistics ? short.statistics.viewCount : "0";
        const likes = short.statistics ? short.statistics.likeCount : "0";
        const comments = short.statistics ? short.statistics.commentCount : "0";
        const date = new Date(short.snippet.publishedAt);

        const card = document.createElement("div");
        card.className = "short-card";
        card.innerHTML = `
                <img src="${short.snippet.thumbnails.high.url}" alt="${
          short.snippet.title
        }" class="short-thumbnail">
                <div class="short-info">
                    <h3 class="short-title">${short.snippet.title}</h3>
                    <div class="stats">
                        ${
                          short.statistics
                            ? `
                            <div class="stat">üëÅÔ∏è ${formatCount(views)}</div>
                            <div class="stat">‚ù§Ô∏è ${formatCount(likes)}</div>
                            <div class="stat">üí¨ ${formatCount(comments)}</div>
                        `
                            : ""
                        }
                        <div class="stat">üìÖ ${date.toLocaleDateString()}</div>
                    </div>
                </div>
            `;
        card.addEventListener("click", () => openModal(short.id.videoId));
        return card;
      }

      async function loadShorts() {
        const loadMoreBtn = document.getElementById("loadMore");
        loadMoreBtn.textContent = "Chargement...";
        loadMoreBtn.disabled = true;

        const data = await fetchShorts();
        const grid = document.getElementById("shortsGrid");

        if (data && data.items.length > 0) {
          grid.innerHTML = "";
          data.items.forEach((short) => {
            grid.appendChild(createShortCard(short));
          });

          nextPageToken = data.nextPageToken;
          if (data.nextPageToken) {
            loadMoreBtn.style.display = "block";
            loadMoreBtn.textContent = "Charger plus";
            loadMoreBtn.disabled = false;
          } else {
            loadMoreBtn.style.display = "none";
          }
        } else {
          loadMoreBtn.style.display = "none";
        }
      }

      document.getElementById("videoModal").addEventListener("click", (e) => {
        if (e.target.id === "videoModal") {
          closeModal();
        }
      });

      // Chargement initial
      loadShorts();
    </script>
  </body>
</html>
